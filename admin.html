<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Histoire - Mon-cours.com</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-logo {
            font-size: 24px;
            font-weight: 700;
        }
        
        .admin-logo span {
            color: #ffcc00;
        }
        
        .admin-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ffcc00;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8B4513;
            font-weight: bold;
        }
        
        .admin-layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .admin-sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .menu-item {
            padding: 15px 25px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background: #34495e;
            border-left-color: #ffcc00;
        }
        
        .menu-item.active {
            background: #34495e;
            border-left-color: #ffcc00;
        }
        
        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .admin-content {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .content-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .content-header h1 {
            color: #8B4513;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #8B4513;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .editor-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .editor-header {
            background: #8B4513;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toolbar {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tool-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-btn:hover {
            background: #e9ecef;
            border-color: #8B4513;
        }
        
        .editor-area {
            padding: 20px;
            min-height: 400px;
            border: 1px solid #ddd;
            margin: 15px;
            border-radius: 5px;
        }
        
        .editor-area:focus {
            outline: none;
            border-color: #8B4513;
        }
        
        .content-block {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 5px;
            position: relative;
        }
        
        .block-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .content-block:hover .block-controls {
            opacity: 1;
        }
        
        .block-btn {
            background: #8B4513;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .metadata-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 42px;
            align-items: center;
        }
        
        .tag {
            background: #eef2ff;
            color: #4b6cb7;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #8B4513;
            color: white;
        }
        
        .btn-primary:hover {
            background: #A0522D;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .articles-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .status-published {
            background: #d4edda;
            color: #155724;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .status-draft {
            background: #fff3cd;
            color: #856404;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .action-cell {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #8B4513;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: #8B4513;
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .article-link {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        
        .article-link a {
            color: #1976d2;
            text-decoration: none;
            font-weight: 500;
        }
        
        .article-link a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .admin-layout {
                flex-direction: column;
            }
            
            .admin-sidebar {
                width: 100%;
            }
            
            .toolbar {
                justify-content: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <div class="admin-nav">
                <div class="admin-logo">
                    Admin <span>Histoire</span> - Mon-cours.com
                </div>
                <div class="admin-user">
                    <span id="user-name">Chargement...</span>
                    <div class="user-avatar" id="user-avatar">MD</div>
                </div>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <nav class="admin-sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>Tableau de bord
                </li>
                <li class="menu-item" data-section="editor">
                    <i class="fas fa-edit"></i>Nouvel article
                </li>
                <li class="menu-item" data-section="articles">
                    <i class="fas fa-newspaper"></i>Articles publi�s
                </li>
                <li class="menu-item" data-section="profile">
                    <i class="fas fa-user"></i>Profil public
                </li>
                <li class="menu-item">
                    <i class="fas fa-sign-out-alt"></i>D�connexion
                </li>
            </ul>
        </nav>

        <main class="admin-content">
            <div id="success-message" class="alert alert-success">
                <i class="fas fa-check-circle"></i> <span id="success-text"></span>
            </div>
            <div id="error-message" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
            </div>

            <section id="dashboard-section" class="content-section">
                <div class="content-header">
                    <h1>Tableau de bord - Histoire</h1>
                    <p>Gestion des contenus p�dagogiques d'Histoire</p>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-articles">0</div>
                        <div class="stat-label">Articles publi�s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-comments">0</div>
                        <div class="stat-label">Commentaires</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-views">0</div>
                        <div class="stat-label">Vues totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="draft-articles">0</div>
                        <div class="stat-label">Articles en brouillon</div>
                    </div>
                </div>

                <div class="articles-list">
                    <div class="content-header">
                        <h2>Articles r�cents</h2>
                        <button class="btn btn-primary" id="new-article-btn">
                            <i class="fas fa-plus"></i> Nouvel article
                        </button>
                    </div>
                    <div id="articles-table-container">
                        <p style="text-align: center; padding: 40px; color: #666;">Chargement des articles...</p>
                    </div>
                </div>
            </section>

            <section id="editor-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 id="editor-title">Nouvel article - Histoire</h1>
                    <p id="editor-subtitle">Cr�ez et modifiez vos contenus p�dagogiques</p>
                </div>

                <div class="metadata-form">
                    <div class="form-group">
                        <label for="article-title">Titre de l'article *</label>
                        <input type="text" id="article-title" placeholder="Titre attractif pour votre article" required>
                    </div>
                    <div class="form-group">
                        <label for="article-excerpt">R�sum� *</label>
                        <textarea id="article-excerpt" placeholder="Court r�sum� de l'article (visible dans les listes)" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tags/Cat�gories</label>
                        <div class="tags-input" id="tags-container">
                            <input type="text" class="tag-input" id="tag-input" placeholder="Ajouter un tag...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="article-image">Image principale</label>
                        <input type="file" id="article-image" accept="image/*">
                        <div id="image-preview" style="margin-top: 10px; display: none;">
                            <img id="preview-img" style="max-width: 200px; max-height: 150px; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div class="editor-container">
                    <div class="editor-header">
                        <h3>Contenu de l'article</h3>
                        <div>
                            <button class="btn btn-secondary" id="add-block-btn">
                                <i class="fas fa-plus"></i> Ajouter un bloc
                            </button>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <button class="tool-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                        <button class="tool-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                        <button class="tool-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                        <button class="tool-btn" data-block="heading"><i class="fas fa-heading"></i> Titre</button>
                        <button class="tool-btn" data-block="paragraph"><i class="fas fa-paragraph"></i> Paragraphe</button>
                        <button class="tool-btn" data-block="list"><i class="fas fa-list"></i> Liste</button>
                        <button class="tool-btn" data-block="table"><i class="fas fa-table"></i> Tableau</button>
                        <button class="tool-btn" data-block="image"><i class="fas fa-image"></i> Image</button>
                        <button class="tool-btn" data-block="separator"><i class="fas fa-minus"></i> S�parateur</button>
                        <button class="tool-btn" data-block="quote"><i class="fas fa-quote-right"></i> Citation</button>
                    </div>
                    
                    <div class="editor-area" id="editor-area" contenteditable="true">
                        <p>Commencez � r�diger votre article ici...</p>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" id="save-draft-btn">
                        <i class="fas fa-save"></i> Sauvegarder brouillon
                    </button>
                    <button class="btn btn-primary" id="publish-btn">
                        <i class="fas fa-paper-plane"></i> Publier l'article
                    </button>
                </div>
            </section>

            <section id="articles-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1>Tous les articles - Histoire</h1>
                    <p>Gestion compl�te de vos publications</p>
                </div>
                <div id="all-articles-container">
                    <p style="text-align: center; padding: 40px; color: #666;">Chargement des articles...</p>
                </div>
            </section>

            <section id="profile-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1>Profil public - Histoire</h1>
                    <p>G�rez votre pr�sentation publique</p>
                </div>
                <div class="metadata-form">
                    <div class="form-group">
                        <label for="profile-name">Nom complet *</label>
                        <input type="text" id="profile-name" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-bio">Biographie *</label>
                        <textarea id="profile-bio" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="profile-specialites">Sp�cialit�s</label>
                        <input type="text" id="profile-specialites" placeholder="S�par�es par des virgules">
                    </div>
                    <div class="form-group">
                        <label for="profile-email">Email de contact</label>
                        <input type="email" id="profile-email">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="save-profile-btn">
                            <i class="fas fa-save"></i> Sauvegarder le profil
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal" id="block-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ajouter un bloc de contenu</h3>
                <button class="modal-close" id="close-modal-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="toolbar" style="justify-content: center; background: white; border: none;">
                    <button class="tool-btn" data-block="paragraph">
                        <i class="fas fa-paragraph"></i> Paragraphe
                    </button>
                    <button class="tool-btn" data-block="heading">
                        <i class="fas fa-heading"></i> Titre
                    </button>
                    <button class="tool-btn" data-block="image">
                        <i class="fas fa-image"></i> Image
                    </button>
                    <button class="tool-btn" data-block="table">
                        <i class="fas fa-table"></i> Tableau
                    </button>
                    <button class="tool-btn" data-block="list">
                        <i class="fas fa-list"></i> Liste
                    </button>
                    <button class="tool-btn" data-block="quote">
                        <i class="fas fa-quote-right"></i> Citation
                    </button>
                    <button class="tool-btn" data-block="separator">
                        <i class="fas fa-minus"></i> S�parateur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGApx2H_xbmE_nupoT1ejskREG5J6BsY8",
            authDomain: "mon-cours-895f2.firebaseapp.com",
            projectId: "mon-cours-895f2",
            storageBucket: "mon-cours-895f2.firebasestorage.app",
            messagingSenderId: "409685517542",
            appId: "1:409685517542:web:b26115d1a84556c6ed8727",
            measurementId: "G-X62EEFG59D"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const articlesRef = collection(db, "histoire-articles");
        const profileRef = doc(db, "histoire-profile", "auteur-principal");

        let currentArticleId = null;
        let articles = [];

        const firebaseApp = {
            async saveArticle(articleData, isPublish = false) {
                try {
                    const articleWithStatus = {
                        ...articleData,
                        status: isPublish ? 'published' : 'draft',
                        updatedAt: new Date().toISOString(),
                        slug: this.createSlug(articleData.titre)
                    };

                    if (currentArticleId) {
                        await updateDoc(doc(db, "histoire-articles", currentArticleId), articleWithStatus);
                        return currentArticleId;
                    } else {
                        const docRef = await addDoc(articlesRef, {
                            ...articleWithStatus,
                            createdAt: new Date().toISOString(),
                            views: 0,
                            likes: 0
                        });
                        return docRef.id;
                    }
                } catch (error) {
                    console.error("Erreur sauvegarde article:", error);
                    throw error;
                }
            },

            async loadArticles() {
                try {
                    const q = query(articlesRef, orderBy('updatedAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    articles = [];
                    querySnapshot.forEach((doc) => {
                        articles.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    return articles;
                } catch (error) {
                    console.error("Erreur chargement articles:", error);
                    return [];
                }
            },

            async loadArticle(articleId) {
                try {
                    const articles = await this.loadArticles();
                    return articles.find(article => article.id === articleId);
                } catch (error) {
                    console.error("Erreur chargement article:", error);
                    return null;
                }
            },

            async deleteArticle(articleId) {
                try {
                    await deleteDoc(doc(db, "histoire-articles", articleId));
                    return true;
                } catch (error) {
                    console.error("Erreur suppression article:", error);
                    return false;
                }
            },

            async uploadImage(file) {
                try {
                    const storageRef = ref(storage, `histoire-images/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    return downloadURL;
                } catch (error) {
                    console.error("Erreur upload image:", error);
                    throw error;
                }
            },

            async saveProfile(profileData) {
                try {
                    await setDoc(profileRef, {
                        ...profileData,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error("Erreur sauvegarde profil:", error);
                    return false;
                }
            },

            async loadProfile() {
                try {
                    const docSnap = await getDoc(profileRef);
                    if (docSnap.exists()) {
                        return docSnap.data();
                    } else {
                        const defaultProfile = {
                            nom: "Dr. Martin Dubois",
                            bio: "Docteur en Histoire et passionn� d'�ducation",
                            specialites: ["Histoire Moderne", "R�volution Fran�aise"],
                            email: "contact@mon-cours.com",
                            createdAt: new Date().toISOString()
                        };
                        await this.saveProfile(defaultProfile);
                        return defaultProfile;
                    }
                } catch (error) {
                    console.error("Erreur chargement profil:", error);
                    return null;
                }
            },

            createSlug(titre) {
                return titre
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-z0-9 -]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim();
            },

            generateArticleHTML(articleData, articleId) {
                const slug = this.createSlug(articleData.titre);
                const fileName = `${slug}.html`;
                
                return `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${articleData.titre} - Mon-cours.com</title>
    <meta name="description" content="${articleData.resume}">
    <meta property="og:title" content="${articleData.titre}">
    <meta property="og:description" content="${articleData.resume}">
    <meta property="og:image" content="${articleData.image || 'https://images.unsplash.com/photo-1576086213369-97a306d36557?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'}">
    <meta property="og:url" content="https://mon-cours.com/histoire/${fileName}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .article-header {
            background: white;
            padding: 40px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .article-title {
            color: #8B4513;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        .article-meta {
            color: #666;
            margin-bottom: 20px;
        }
        .article-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin: 20px 0;
        }
        .article-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .article-content h2 {
            color: #8B4513;
            margin: 30px 0 15px;
        }
        .article-content p {
            margin-bottom: 20px;
        }
        .back-link {
            display: inline-block;
            margin-top: 30px;
            color: #8B4513;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <article>
            <header class="article-header">
                <h1 class="article-title">${articleData.titre}</h1>
                <div class="article-meta">
                    <strong>Par ${articleData.auteur}</strong> | ${new Date().toLocaleDateString('fr-FR')}
                </div>
                ${articleData.image ? `<img src="${articleData.image}" alt="${articleData.titre}" class="article-image">` : ''}
            </header>
            
            <div class="article-content">
                ${articleData.contenu}
                
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
                    <a href="../histoire.html" class="back-link"> Retour aux articles d'Histoire</a>
                </div>
            </div>
        </article>
    </div>
</body>
</html>`;
            },

            async downloadHTMLFile(htmlContent, fileName) {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };

        window.firebaseApp = firebaseApp;
    </script>

    <script>
        let currentArticleId = null;
        let tags = ['Histoire'];
        let articleUrl = '';

        // Fonction pour afficher les sections
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            const sectionElement = document.getElementById(sectionName + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Mettre � jour le menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeMenuItem = document.querySelector(`.menu-item[data-section="${sectionName}"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
            }

            // Charger les donn�es si n�cessaire
            if (sectionName === 'dashboard') {
                loadStats();
                loadArticles();
            } else if (sectionName === 'articles') {
                loadAllArticles();
            }
        }

        // Fonctions de messages
        function showSuccess(message) {
            const alert = document.getElementById('success-message');
            const text = document.getElementById('success-text');
            text.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const alert = document.getElementById('error-message');
            const text = document.getElementById('error-text');
            text.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Gestion des tags
        function setupTagInput() {
            document.getElementById('tag-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim()) {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });
        }

        function addTag(tagText) {
            if (!tags.includes(tagText)) {
                tags.push(tagText);
                renderTags();
            }
        }

        function removeTag(tagText) {
            tags = tags.filter(tag => tag !== tagText);
            renderTags();
        }

        function renderTags() {
            const tagsContainer = document.getElementById('tags-container');
            const tagInput = document.getElementById('tag-input');
            tagsContainer.innerHTML = '';
            
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="tag-remove">�</span>
                `;
                tagElement.querySelector('.tag-remove').addEventListener('click', () => removeTag(tag));
                tagsContainer.appendChild(tagElement);
            });
            
            tagsContainer.appendChild(tagInput);
        }

        // Gestion du modal
        function showBlockModal() {
            document.getElementById('block-modal').style.display = 'flex';
        }

        function closeBlockModal() {
            document.getElementById('block-modal').style.display = 'none';
        }

        // Fonctions d'�dition
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('editor-area').focus();
        }

        function insertBlock(type) {
            const editor = document.getElementById('editor-area');
            let html = '';
            
            switch(type) {
                case 'paragraph':
                    html = '<div class="content-block"><p>Nouveau paragraphe...</p><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
                case 'heading':
                    html = '<div class="content-block"><h2>Nouveau titre</h2><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
                case 'image':
                    html = '<div class="content-block"><div style="text-align: center; padding: 20px; background: #f8f9fa; border: 2px dashed #ddd; cursor: pointer;"><p><i class="fas fa-image" style="font-size: 48px; color: #ccc;"></i></p><p>Cliquez pour ajouter une image</p></div><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
                case 'table':
                    html = '<div class="content-block"><table style="width: 100%; border-collapse: collapse;"><tr><th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;">Colonne 1</th><th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;">Colonne 2</th></tr><tr><td style="border: 1px solid #ddd; padding: 8px;">Donn�e 1</td><td style="border: 1px solid #ddd; padding: 8px;">Donn�e 2</td></tr></table><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
                case 'list':
                    html = '<div class="content-block"><ul><li>Premier �l�ment</li><li>Deuxi�me �l�ment</li><li>Troisi�me �l�ment</li></ul><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
                case 'quote':
                    html = '<div class="content-block"><blockquote style="border-left: 4px solid #8B4513; padding-left: 15px; margin: 15px 0; font-style: italic; color: #666; background: #f8f9fa; padding: 15px;">Citation importante...</blockquote><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
                case 'separator':
                    html = '<div class="content-block"><hr style="border: none; border-top: 2px solid #8B4513; margin: 20px 0;"><div class="block-controls"><button class="block-btn"><i class="fas fa-arrow-up"></i></button><button class="block-btn"><i class="fas fa-arrow-down"></i></button><button class="block-btn"><i class="fas fa-trash"></i></button></div></div>';
                    break;
            }
            
            editor.innerHTML += html;
            closeBlockModal();
        }

        // Validation du formulaire
        function validateForm() {
            const title = document.getElementById('article-title').value.trim();
            const excerpt = document.getElementById('article-excerpt').value.trim();
            const content = document.getElementById('editor-area').innerHTML.trim();
            
            if (!title) { 
                showError('Le titre est obligatoire'); 
                return false; 
            }
            
            if (!excerpt) { 
                showError('Le r�sum� est obligatoire'); 
                return false; 
            }
            
            if (!content || content === '<br>') { 
                showError('Le contenu ne peut pas �tre vide'); 
                return false; 
            }
            
            return true;
        }

        // Gestion de la publication
        async function saveDraft() { 
            await saveArticle(false); 
        }

        async function publishArticle() { 
            await saveArticle(true); 
        }

        async function saveArticle(isPublish = false) {
            if (!validateForm()) return;

            try {
                showSuccess(isPublish ? 'Publication en cours...' : 'Sauvegarde en cours...');

                const imageFile = document.getElementById('article-image').files[0];
                let imageUrl = null;
                
                if (imageFile) {
                    imageUrl = await firebaseApp.uploadImage(imageFile);
                }

                const articleData = {
                    titre: document.getElementById('article-title').value,
                    resume: document.getElementById('article-excerpt').value,
                    contenu: document.getElementById('editor-area').innerHTML,
                    tags: tags,
                    image: imageUrl,
                    auteur: document.getElementById('user-name').textContent,
                    datePublication: isPublish ? new Date().toISOString() : null
                };

                const articleId = await firebaseApp.saveArticle(articleData, isPublish);
                
                if (isPublish) {
                    // G�n�rer la page HTML
                    const htmlContent = firebaseApp.generateArticleHTML(articleData, articleId);
                    const slug = firebaseApp.createSlug(articleData.titre);
                    const fileName = `${slug}.html`;
                    
                    // T�l�charger le fichier HTML
                    await firebaseApp.downloadHTMLFile(htmlContent, fileName);
                    
                    showSuccess('Article publi� et page HTML g�n�r�e !');
                    
                    // Afficher le lien
                    setTimeout(() => {
                        showSection('dashboard');
                        showArticleLink(fileName);
                        resetEditor();
                    }, 2000);
                } else {
                    showSuccess('Brouillon sauvegard� avec succ�s');
                    currentArticleId = articleId;
                }

            } catch (error) {
                showError('Erreur: ' + error.message);
            }
        }

        function showArticleLink(fileName) {
            const linkContainer = document.createElement('div');
            linkContainer.className = 'article-link';
            linkContainer.innerHTML = `
                <strong>Votre article a �t� publi� !</strong><br>
                <a href="${fileName}" target="_blank">${fileName}</a> - 
                <button class="btn btn-secondary" style="padding: 5px 10px; margin-left: 10px;">
                    <i class="fas fa-copy"></i> Copier le lien
                </button>
            `;
            
            linkContainer.querySelector('button').addEventListener('click', () => copyLink(fileName));
            document.getElementById('dashboard-section').insertBefore(linkContainer, document.getElementById('stats-grid'));
        }

        function copyLink(fileName) {
            const fullUrl = window.location.origin + '/' + fileName;
            navigator.clipboard.writeText(fullUrl).then(() => {
                showSuccess('Lien copi� dans le presse-papier !');
            });
        }

        function resetEditor() {
            document.getElementById('article-title').value = '';
            document.getElementById('article-excerpt').value = '';
            document.getElementById('editor-area').innerHTML = '<p>Commencez � r�diger votre article ici...</p>';
            document.getElementById('article-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
            tags = ['Histoire'];
            renderTags();
            currentArticleId = null;
            document.getElementById('editor-title').textContent = 'Nouvel article - Histoire';
            document.getElementById('editor-subtitle').textContent = 'Cr�ez et modifiez vos contenus p�dagogiques';
        }

        // Chargement des donn�es
        async function loadStats() {
            try {
                const articles = await firebaseApp.loadArticles();
                const publishedArticles = articles.filter(a => a.status === 'published');
                const draftArticles = articles.filter(a => a.status === 'draft');
                const totalViews = articles.reduce((sum, article) => sum + (article.views || 0), 0);

                document.getElementById('total-articles').textContent = publishedArticles.length;
                document.getElementById('draft-articles').textContent = draftArticles.length;
                document.getElementById('total-views').textContent = totalViews;
                document.getElementById('total-comments').textContent = '0';
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function loadArticles() {
            try {
                const articles = await firebaseApp.loadArticles();
                updateArticlesList(articles);
            } catch (error) {
                console.error('Erreur chargement articles:', error);
            }
        }

        function updateArticlesList(articles) {
            const container = document.getElementById('articles-table-container');
            
            if (articles.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Aucun article publi�</p>';
                return;
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th>Vues</th>
                            <th>Lien</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            articles.slice(0, 5).forEach(article => {
                const date = new Date(article.updatedAt).toLocaleDateString('fr-FR');
                const statusClass = article.status === 'published' ? 'status-published' : 'status-draft';
                const statusText = article.status === 'published' ? 'Publi�' : 'Brouillon';
                const fileName = article.slug ? `${article.slug}.html` : '#';
                
                html += `
                    <tr>
                        <td>${article.titre}</td>
                        <td>${date}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>${article.views || 0}</td>
                        <td>
                            ${article.status === 'published' ? 
                                `<a href="${fileName}" target="_blank" style="color: #8B4513;">${fileName}</a>` : 
                                'Non publi�'
                            }
                        </td>
                        <td class="action-cell">
                            <button class="action-btn edit-article" data-id="${article.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-article" data-id="${article.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Ajouter les �couteurs d'�v�nements
            document.querySelectorAll('.edit-article').forEach(btn => {
                btn.addEventListener('click', () => editArticle(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-article').forEach(btn => {
                btn.addEventListener('click', () => deleteArticle(btn.dataset.id));
            });
        }

        async function loadAllArticles() {
            try {
                const articles = await firebaseApp.loadArticles();
                const container = document.getElementById('all-articles-container');
                
                if (articles.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Aucun article</p>';
                    return;
                }

                let html = `
                    <div class="articles-list">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Vues</th>
                                    <th>Lien</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                articles.forEach(article => {
                    const date = new Date(article.updatedAt).toLocaleDateString('fr-FR');
                    const statusClass = article.status === 'published' ? 'status-published' : 'status-draft';
                    const statusText = article.status === 'published' ? 'Publi�' : 'Brouillon';
                    const fileName = article.slug ? `${article.slug}.html` : '#';
                    
                    html += `
                        <tr>
                            <td>${article.titre}</td>
                            <td>${date}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>${article.views || 0}</td>
                            <td>
                                ${article.status === 'published' ? 
                                    `<a href="${fileName}" target="_blank" style="color: #8B4513;">${fileName}</a>` : 
                                    'Non publi�'
                                }
                            </td>
                            <td class="action-cell">
                                <button class="action-btn edit-article" data-id="${article.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-article" data-id="${article.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;

              // Ajouter les �couteurs d'�v�nements
                document.querySelectorAll('.edit-article').forEach(btn => {
                    btn.addEventListener('click', () => editArticle(btn.dataset.id));
                });
                
                document.querySelectorAll('.delete-article').forEach(btn => {
                    btn.addEventListener('click', () => deleteArticle(btn.dataset.id));
                });
            } catch (error) {
                console.error('Erreur chargement articles:', error);
            }
        }

        // Gestion du profil
        async function saveProfile() {
            const profileData = {
                nom: document.getElementById('profile-name').value,
                bio: document.getElementById('profile-bio').value,
                specialites: document.getElementById('profile-specialites').value.split(',').map(s => s.trim()).filter(s => s),
                email: document.getElementById('profile-email').value
            };

            try {
                await firebaseApp.saveProfile(profileData);
                showSuccess('Profil sauvegard� avec succ�s');
                document.getElementById('user-name').textContent = profileData.nom;
                document.getElementById('user-avatar').textContent = profileData.nom.split(' ').map(n => n[0]).join('');
            } catch (error) {
                showError('Erreur lors de la sauvegarde du profil');
            }
        }

        // �dition d'article
        async function editArticle(articleId) {
            try {
                const article = await firebaseApp.loadArticle(articleId);
                if (article) {
                    showSection('editor');
                    currentArticleId = articleId;
                    
                    document.getElementById('article-title').value = article.titre || '';
                    document.getElementById('article-excerpt').value = article.resume || '';
                    document.getElementById('editor-area').innerHTML = article.contenu || '';
                    
                    tags = article.tags || ['Histoire'];
                    renderTags();
                    
                    if (article.image) {
                        document.getElementById('preview-img').src = article.image;
                        document.getElementById('image-preview').style.display = 'block';
                    }
                    
                    document.getElementById('editor-title').textContent = '�dition - ' + article.titre;
                    document.getElementById('editor-subtitle').textContent = 'Modifiez votre article';
                    
                    showSuccess('Article charg� pour �dition');
                }
            } catch (error) {
                showError('Erreur lors du chargement de l\'article');
            }
        }

        // Suppression d'article
        async function deleteArticle(articleId) {
            if (confirm('�tes-vous s�r de vouloir supprimer cet article ? Cette action est irr�versible.')) {
                try {
                    const success = await firebaseApp.deleteArticle(articleId);
                    if (success) {
                        showSuccess('Article supprim� avec succ�s');
                        loadStats();
                        loadArticles();
                    } else {
                        showError('Erreur lors de la suppression');
                    }
                } catch (error) {
                    showError('Erreur lors de la suppression');
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            await initAdmin();
        });

        async function initAdmin() {
            try {
                // Charger le profil
                const profile = await firebaseApp.loadProfile();
                if (profile) {
                    document.getElementById('user-name').textContent = profile.nom;
                    document.getElementById('user-avatar').textContent = profile.nom.split(' ').map(n => n[0]).join('');
                    
                    document.getElementById('profile-name').value = profile.nom || '';
                    document.getElementById('profile-bio').value = profile.bio || '';
                    document.getElementById('profile-specialites').value = profile.specialites ? profile.specialites.join(', ') : '';
                    document.getElementById('profile-email').value = profile.email || '';
                }

                // Configuration des �couteurs d'�v�nements
                setupEventListeners();
                
                await loadStats();
                await loadArticles();
                renderTags();

                showSuccess('Admin Histoire connect� � Firebase');

            } catch (error) {
                showError('Erreur de connexion � la base de donn�es');
                console.error('Erreur initialisation:', error);
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.menu-item[data-section]').forEach(item => {
                item.addEventListener('click', () => showSection(item.dataset.section));
            });

            // Boutons
            document.getElementById('new-article-btn').addEventListener('click', () => showSection('editor'));
            document.getElementById('add-block-btn').addEventListener('click', showBlockModal);
            document.getElementById('close-modal-btn').addEventListener('click', closeBlockModal);
            document.getElementById('save-draft-btn').addEventListener('click', saveDraft);
            document.getElementById('publish-btn').addEventListener('click', publishArticle);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);

            // Outils d'�dition
            document.querySelectorAll('.tool-btn[data-command]').forEach(btn => {
                btn.addEventListener('click', () => formatText(btn.dataset.command));
            });

            document.querySelectorAll('.tool-btn[data-block]').forEach(btn => {
                btn.addEventListener('click', () => insertBlock(btn.dataset.block));
            });

            // Modal
            document.getElementById('block-modal').addEventListener('click', function(e) {
                if (e.target === this) closeBlockModal();
            });

            // Pr�visualisation d'image
            document.getElementById('article-image').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview-img').src = e.target.result;
                        document.getElementById('image-preview').style.display = 'block';
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }

        // Rendre les fonctions accessibles globalement
        window.showSection = showSection;
        window.showSuccess = showSuccess;
        window.showError = showError;
        window.updateArticlesList = updateArticlesList;
        window.editArticle = editArticle;
        window.deleteArticle = deleteArticle;
        window.copyLink = copyLink;
    </script>
</body>
</html>
